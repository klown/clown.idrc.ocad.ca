<!DOCTYPE html>
<html>
<head>
<script type="text/javascript" src="https://code.jquery.com/jquery-latest.min.js"></script>
<script type="text/javascript">

    var pwdUI;
    var realPwd;
    var showPassword;
    var echoKeys;
    var deleteState = false;    // one of "del", "ctrl-d", or false

    jQuery (document).ready (function() {
        pwdUI = document.getElementById ('pwdUI');
        realPwd = document.getElementById ('realPwd');
        showPassword = document.getElementById ('demo');
        echoKeys = document.getElementById ('keys');
    
        // For debugging, make sure the @value attributes are empty.
        realPwd.value = pwdUI.value = "";

        jQuery (pwdUI).keydown (handleKeyDown);
        jQuery (pwdUI).keypress (handleKeyPress);
    });

    function handleKeyDown (keyEvent) {
        if (isSpecial (keyEvent) && !deleteState)
            return;
        
        // Predicts what the password will be after deletion, and modify readPwd
        // as appropriate (hack?).
        if (deleteState) {
            var afterDeletion;

            function updateAndShow() {
                realPwd.value = afterDeletion;
                echoKey (String.fromCharCode (keyEvent.which));
                showValue();
                deleteState = false;
            }

            // Check for zero or one character deleted.
            if (pwdUI.selectionStart === pwdUI.selectionEnd) {

                // Check for deletion before first character, which is no
                // deletion.  Echo the key, and bail.
                if ((pwdUI.selectionStart === 0) && (deleteState === "del")) {
                    echoKey (String.fromCharCode (keyEvent.which));
                    deleteState = false;
                    return;
                }

                // Check for deletion of single character by ctrl-d.
                //
                if (deleteState === "ctrl-d") {
                    afterDeletion = realPwd.value.slice (0, pwdUI.selectionStart);
                    afterDeletion += realPwd.value.slice (pwdUI.selectionEnd+1, pwdUI.length);
                    updateAndShow();
                    return;
                }

                // Check for empty input field.
                if (pwdUI.value.length === 0) {
                    afterDeletion = "";
                    updateAndShow();
                    return;
                }
                else {
                    afterDeletion = realPwd.value.slice (0, pwdUI.selectionStart-1);
                }
            }
            else {
                afterDeletion = realPwd.value.slice (0, pwdUI.selectionStart);
            }
            afterDeletion += realPwd.value.slice (pwdUI.selectionEnd);
            updateAndShow();
        }
    }

    function handleKeyPress (keyEvent) {
        if (isSpecial (keyEvent))
            return;

        var keyText = String.fromCharCode (keyEvent.which);
        if (!deleteState) {
            echoKey (keyText);
            storeAndObscure (keyText);
            showValue();
            keyEvent.preventDefault();
        }
    }

    function echoKey (keyText) {
        echoKeys.innerHTML = keyText;
    }
    
    function showValue (keyEvent) {
        showPassword.innerHTML = realPwd.value;
    }
    
    function storeAndObscure (keyText) {
        if (pwdUI.selectionStart === pwdUI.value.length) {
            realPwd.value += keyText;
        }
        else {
            var newString = realPwd.value.slice (0, pwdUI.selectionStart);
            newString += keyText;
            newString += realPwd.value.slice (pwdUI.selectionEnd);
            realPwd.value = newString;
        }
        pwdUI.value = '*'.repeat (realPwd.value.length);
    }
    
    function isSpecial (keyEvent) {
        if (keyEvent.metaKey || keyEvent.which === 32) {
            console.log ("cmd");
            if (keyEvent.which === 20) {
                console.log ('cmd+space');
            }
        }
        return (
            (detectDeletion (keyEvent)) ||
            (isArrow (keyEvent)) ||
            (keyEvent.altKey || keyEvent.ctrlKey || keyEvent.metaKey) ||
            (keyEvent.shiftKey && keyEvent.type === "keydown")
        );
    }
    
    function isArrow (keyEvent) {
        if (keyEvent.type === "keydown") {
            return (
                keyEvent.which === 37 ||
                keyEvent.which === 38 ||
                keyEvent.which === 39 ||
                keyEvent.which === 40
            );
        }
        else {  // only reach here if FF and keyEvent.type === "keypress" (?)
            return (keyEvent.which === 0);
        }
    }

    function detectDeletion (keyEvent) {
        if (keyEvent.which === 8) /* Delete Key */ {
            deleteState = "del";
        }
        // Check for ctrl-h or ctrl-d.
        else if (keyEvent.ctrlKey && !keyEvent.shiftKey) {
            if (keyEvent.which === 72) { // 'h'
                deleteState = "del";
            }
            else if (keyEvent.which === 68) { // 'd'
                deleteState = "ctrl-d";
            }
        }
        else {
            deleteState = false;
        }
        return deleteState;
    }

</script>
</head>
<body>
<p tabindex="0" aria-activedescendant="keys">A form with an html5 &lt;input&gt; type="text" field used as a password:</p>

<form>
  <label for="thePwd" >Password:</label> <input id="pwdUI" type="text" name="pw" pattern=".{6,}" title="Six or more characters">
  <input id="realPwd" type="hidden" name="realPwd" value="">
</form>

<p>The password is: <span id="demo" style="margin-left: 0.5em; padding-left: 0.5em; padding-right: 0.5em; border: 1px solid blue"></span></p>
<p>Key: <span id="keys" style="margin-left: 0.5em; padding-left: 0.5em; padding-right: 0.5em; border: 1px solid blue"></span></p>

<hr>
<form>
  <label for="thePwd" >Another text field:</label> <input type="text" name="pw" pattern=".{6,}" title="Six or more characters">
</form>
</body>
</html>
